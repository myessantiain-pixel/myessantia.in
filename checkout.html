<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>ESSENCE · secure checkout</title>
  
  <!-- Font Awesome 6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <!-- Premium Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300..700&family=Montserrat:wght@300..900&display=swap" rel="stylesheet">
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  
  <!-- Common CSS -->
  <link rel="stylesheet" href="common.css">
  <link rel="stylesheet" href="header.css">
  <link rel="stylesheet" href="footer.css">
  
  <style>
    /* ===== GLOBAL & RESETS ===== */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Inter', 'Montserrat', sans-serif; 
      background: #faf9f7; 
      color: #1e1e1e; 
      overflow-x: hidden;
      line-height: 1.4;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container { 
      width: 100%; 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 0 16px; 
    }
    @media (min-width: 640px) { 
      .container { padding: 0 24px; } 
    }

    /* ===== CHECKOUT HEADER ===== */
    .checkout-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1.5rem 0 1.2rem;
      flex-wrap: wrap;
      gap: 0.8rem;
    }
    .checkout-header h1 {
      font-size: clamp(1.6rem, 4vw, 2rem);
      font-weight: 800;
      color: #000;
      text-transform: uppercase;
      letter-spacing: -0.02em;
      font-family: 'Montserrat', sans-serif;
    }
    .checkout-header h1 span {
      color: #d4af37;
      font-weight: 900;
    }
    .secure-badge {
      background: #000;
      padding: 0.5rem 1.2rem;
      border-radius: 60px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
      color: #fff;
      border: 2px solid #d4af37;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .secure-badge i {
      color: #d4af37;
      margin-right: 0.3rem;
    }

    /* ===== EMPTY CART ===== */
    .empty-cart-checkout {
      text-align: center;
      padding: 3rem 1.5rem;
      background: #ffffff;
      border-radius: 32px;
      border: 2px solid #000;
      box-shadow: 6px 6px 0 rgba(0,0,0,0.15);
      margin: 1.5rem 0;
    }
    .empty-cart-checkout i {
      font-size: 3.5rem;
      color: #d4af37;
      margin-bottom: 1rem;
    }
    .empty-cart-checkout h3 {
      font-family: 'Montserrat', sans-serif;
      font-size: 1.5rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
    }
    .empty-cart-checkout p {
      color: #666;
      margin-bottom: 1.5rem;
      font-size: 0.95rem;
    }
    .empty-cart-checkout .btn {
      display: inline-block;
      padding: 0.9rem 2.2rem;
      background: #000;
      color: #fff;
      text-decoration: none;
      border-radius: 60px;
      font-weight: 600;
      transition: all 0.2s;
      border: 2px solid #000;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.9rem;
    }
    .empty-cart-checkout .btn:hover {
      background: #d4af37;
      color: #000;
      border-color: #d4af37;
    }

    /* ===== MAIN CHECKOUT GRID ===== */
    .checkout-grid {
      display: grid;
      grid-template-columns: 1.2fr 0.9fr;
      gap: 1.5rem;
      align-items: stretch;
      margin-bottom: 2.5rem;
    }

    /* ===== LEFT COLUMN - more compact ===== */
    .left-column {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    /* ===== SECTION CARDS - compact ===== */
    .section-card {
      background: #ffffff;
      border-radius: 24px;
      padding: 1.2rem 1.5rem;
      border: 2px solid #000;
      box-shadow: 6px 6px 0 rgba(0,0,0,0.15);
      transition: all 0.2s;
    }
    .section-card:hover {
      box-shadow: 4px 4px 0 rgba(0,0,0,0.15);
      transform: translateY(-1px);
    }
    .section-title {
      font-size: 1.1rem;
      font-weight: 800;
      margin-bottom: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.8rem;
      font-family: 'Montserrat', sans-serif;
      text-transform: uppercase;
      letter-spacing: -0.02em;
    }
    .section-title .step-number {
      background: #000;
      color: #d4af37;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 1rem;
      border: 2px solid #d4af37;
    }

    /* ===== FORM STYLES - compact ===== */
    .form-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .form-group {
      flex: 1 1 calc(50% - 0.5rem);
      min-width: 130px;
    }
    .form-group.full-width {
      flex: 1 1 100%;
    }
    label {
      display: block;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #000;
      margin-bottom: 0.2rem;
      font-weight: 600;
    }
    input, select {
      width: 100%;
      padding: 0.7rem 1rem;
      border: 2px solid #000;
      border-radius: 50px;
      background: #ffffff;
      font-size: 0.85rem;
      transition: 0.15s;
      outline: none;
      font-family: 'Inter', sans-serif;
      font-weight: 400;
    }
    input:focus, select:focus {
      border-color: #d4af37;
      box-shadow: 0 0 0 3px rgba(212,175,55,0.15);
    }

    /* ===== CHECKBOX ROW ===== */
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      margin-top: 0.5rem;
    }
    .checkbox-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #d4af37;
    }
    .checkbox-row label {
      display: inline;
      text-transform: none;
      font-size: 0.8rem;
      color: #1e1e1e;
      font-weight: 400;
    }

    /* ===== SHIPPING METHOD CARDS - compact ===== */
    .radio-card {
      border: 2px solid #000;
      border-radius: 50px;
      padding: 0.7rem 1.2rem;
      margin-bottom: 0.6rem;
      display: flex;
      align-items: center;
      gap: 0.8rem;
      transition: 0.15s;
      cursor: pointer;
      background: #ffffff;
    }
    .radio-card.selected {
      border-color: #d4af37;
      background: #fcf9f4;
      box-shadow: 0 0 0 2px #d4af37;
    }
    .radio-card input[type="radio"] {
      width: 16px;
      height: 16px;
      accent-color: #d4af37;
      flex-shrink: 0;
    }
    .radio-content {
      flex: 1;
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      align-items: center;
      gap: 0.8rem;
      flex-wrap: wrap;
      font-weight: 500;
    }
    .radio-price {
      font-weight: 700;
      color: #000;
      white-space: nowrap;
    }
    .free-badge {
      background: #2e7d32;
      color: white;
      font-size: 0.6rem;
      padding: 0.2rem 0.6rem;
      border-radius: 40px;
      margin-left: 0.5rem;
      font-weight: 700;
      border: 1px solid #000;
    }

    /* ===== RIGHT PANEL - order summary, equal height ===== */
    .right-column {
      display: flex;
      flex-direction: column;
      height: fit-content;
      position: sticky;
      top: 20px;
    }
    .order-summary {
      background: #ffffff;
      border-radius: 32px;
      padding: 1.5rem;
      border: 2px solid #000;
      box-shadow: 6px 6px 0 rgba(0,0,0,0.15);
      width: 100%;
    }
    .summary-title {
      font-size: 1.3rem;
      font-weight: 800;
      border-bottom: 3px solid #000;
      padding-bottom: 0.8rem;
      margin-bottom: 1.2rem;
      font-family: 'Montserrat', sans-serif;
      text-transform: uppercase;
      letter-spacing: -0.02em;
    }
    .summary-title span {
      color: #d4af37;
      font-weight: 900;
    }

    /* ===== CART ITEMS - compact with working quantity controls ===== */
    .cart-items-container {
      max-height: 300px;
      overflow-y: auto;
      padding-right: 4px;
      margin-bottom: 0.8rem;
      scrollbar-width: thin;
    }
    .cart-items-container::-webkit-scrollbar {
      width: 4px;
    }
    .cart-items-container::-webkit-scrollbar-thumb {
      background: #d4af37;
      border-radius: 4px;
    }
    .cart-item {
      display: flex;
      gap: 0.8rem;
      margin-bottom: 1.2rem;
      align-items: center;
      padding: 0.5rem;
      border: 1px solid #eee;
      border-radius: 16px;
      transition: all 0.2s;
    }
    .cart-item:hover {
      border-color: #d4af37;
      background: #fcf9f4;
    }
    .item-image {
      width: 60px;
      height: 60px;
      background: #ece5dc;
      border-radius: 16px;
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
      border: 2px solid #000;
    }
    .item-details {
      flex: 1;
      min-width: 0;
    }
    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.2rem;
    }
    .item-details h4 {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      font-size: 0.85rem;
      color: #000;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
    }
    .item-price {
      font-weight: 800;
      color: #d4af37;
      font-size: 0.85rem;
      white-space: nowrap;
    }
    .item-meta {
      font-size: 0.6rem;
      color: #666;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 0.3rem;
    }
    .qty-control {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .qty-btn {
      background: #f5f2ee;
      border: 2px solid #000;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.9rem;
      transition: 0.1s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #000;
    }
    .qty-btn:hover {
      background: #d4af37;
      color: #000;
    }
    .qty-btn.remove-btn {
      background: #fee;
      color: #c00;
      margin-left: 0.3rem;
      width: 24px;
      height: 24px;
      font-size: 0.8rem;
    }
    .qty-btn.remove-btn:hover {
      background: #c00;
      color: white;
    }
    .qty-value {
      font-weight: 700;
      font-size: 0.8rem;
      min-width: 20px;
      text-align: center;
    }

    /* ===== TRUST BADGE SECTION - NEW DYNAMIC SECTION ===== */
    .trust-section {
      margin-top: 1rem;
      background: #ffffff;
      border-radius: 24px;
      padding: 1rem 1.2rem;
      border: 2px solid #000;
      box-shadow: 6px 6px 0 rgba(0,0,0,0.15);
    }
    .trust-title {
      font-size: 1rem;
      font-weight: 800;
      margin-bottom: 0.8rem;
      font-family: 'Montserrat', sans-serif;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .trust-title i {
      color: #d4af37;
      font-size: 1.1rem;
    }
    .trust-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.8rem;
    }
    .trust-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.4rem 0.6rem;
      background: #f8f5f1;
      border-radius: 40px;
      border: 1px solid #000;
    }
    .trust-item i {
      color: #d4af37;
      font-size: 0.8rem;
    }
    .trust-item.success i {
      color: #2e7d32;
    }
    .trust-item.warning i {
      color: #ed6c02;
    }
    .return-policy {
      margin-top: 0.8rem;
      padding: 0.8rem;
      background: #fcf9f4;
      border-radius: 16px;
      border: 2px dashed #d4af37;
    }
    .return-policy p {
      font-size: 0.75rem;
      font-weight: 500;
      color: #000;
      margin-bottom: 0.3rem;
    }
    .return-policy p i {
      color: #d4af37;
      margin-right: 0.3rem;
    }
    .return-policy ul {
      list-style: none;
      padding-left: 1.2rem;
    }
    .return-policy ul li {
      font-size: 0.7rem;
      color: #666;
      margin-bottom: 0.2rem;
      position: relative;
    }
    .return-policy ul li::before {
      content: "•";
      color: #d4af37;
      font-weight: bold;
      position: absolute;
      left: -1rem;
    }
    .razorpay-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      background: #000;
      color: white;
      padding: 0.2rem 0.8rem;
      border-radius: 40px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-top: 0.3rem;
      border: 1px solid #d4af37;
    }
    .razorpay-badge i {
      color: #d4af37;
    }

    /* ===== PROMO SECTION ===== */
    .promo-inside {
      background: #f8f5f1;
      border-radius: 20px;
      padding: 1rem 1.2rem;
      margin: 0.8rem 0 1rem;
      border: 2px solid #000;
    }
    .promo-inside p {
      font-weight: 700;
      margin-bottom: 0.5rem;
      font-size: 0.8rem;
      text-transform: uppercase;
    }
    .promo-flex {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .promo-flex input {
      flex: 1;
      min-width: 140px;
      background: white;
      border: 2px solid #000;
      padding: 0.6rem 1rem;
      border-radius: 50px;
      font-size: 0.8rem;
    }
    .promo-btn {
      background: #000;
      border: 2px solid #000;
      color: white;
      padding: 0.6rem 1.2rem;
      border-radius: 50px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
      font-family: 'Inter', sans-serif;
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.8rem;
    }
    .promo-btn:hover {
      background: #d4af37;
      color: #000;
      border-color: #d4af37;
    }

    /* ===== PRICE BREAKDOWN ===== */
    .price-line {
      display: flex;
      justify-content: space-between;
      margin: 0.4rem 0;
      font-size: 0.85rem;
      font-weight: 500;
    }
    .total-line {
      font-weight: 800;
      font-size: 1.4rem;
      border-top: 3px solid #000;
      padding-top: 0.8rem;
      margin: 0.8rem 0 1rem;
      font-family: 'Montserrat', sans-serif;
      color: #000;
      display: flex;
      justify-content: space-between;
    }

    /* ===== PLACE ORDER BUTTON ===== */
    .place-order-btn {
      background: #d4af37;
      border: 2px solid #000;
      width: 100%;
      padding: 1.2rem;
      border-radius: 60px;
      font-weight: 700;
      font-size: 1rem;
      color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.6rem;
      cursor: pointer;
      transition: 0.2s;
      margin-bottom: 1rem;
      font-family: 'Montserrat', sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 4px 4px 0 rgba(0,0,0,0.15);
    }
    .place-order-btn:hover:not(:disabled) {
      background: #000;
      color: #d4af37;
      border-color: #d4af37;
      transform: translateY(-2px);
      box-shadow: 6px 6px 0 rgba(0,0,0,0.15);
    }

    /* ===== PAYMENT ICONS ===== */
    .payment-icons-sm {
      display: flex;
      justify-content: center;
      gap: 0.8rem;
      color: #000;
      font-size: 1.4rem;
      flex-wrap: wrap;
    }
    .payment-icons-sm i:hover {
      color: #d4af37;
    }

    /* ===== RESPONSIVE BREAKPOINTS ===== */
    @media (max-width: 992px) {
      .checkout-grid {
        grid-template-columns: 1fr;
        gap: 1.2rem;
      }
      .right-column {
        position: static;
      }
      .cart-items-container {
        max-height: 250px;
      }
    }

    @media (max-width: 768px) {
      .form-group {
        flex: 1 1 100%;
      }
      .radio-content {
        flex-direction: column;
        align-items: flex-start;
      }
      .cart-item {
        flex-wrap: wrap;
      }
      .trust-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .checkout-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .section-card {
        padding: 1rem;
      }
      .item-details h4 {
        max-width: 100px;
      }
      .total-line {
        font-size: 1.2rem;
      }
    }

    /* ===== SCROLL TOP BUTTON ===== */
    .scroll-top {
      position: fixed; bottom: 20px; right: 20px; 
      background: #000; color: #d4af37; width: 44px; height: 44px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; 
      border: 2px solid #d4af37; box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      opacity: 0; transform: translateY(15px); transition: 0.2s; z-index: 100;
      font-size: 1.2rem; cursor: pointer;
    }
    .scroll-top.visible { opacity: 1; transform: translateY(0); }
    .scroll-top:hover { background: #d4af37; color: #000; border-color: #000; }
  </style>
</head>
<body>
  
  <!-- Header loaded dynamically -->
  <div id="header"></div>
  
  <!-- Scroll to top button -->
  <button class="scroll-top" id="scrollTop" onclick="window.scrollTo({top:0,behavior:'smooth'})"><i class="fa-solid fa-arrow-up"></i></button>

  <main>
    <div class="container">
      <!-- checkout header -->
      <div class="checkout-header">
        <h1>checkout <span>· essence</span></h1>
        <div class="secure-badge"><i class="fa-solid fa-lock"></i> 100% secure</div>
      </div>

      <!-- Cart items will be loaded dynamically -->
      <div id="checkout-content"></div>
    </div>
  </main>

  <!-- Footer loaded dynamically -->
  <div id="footer"></div>

  <!-- Common Modals -->
  <div id="common-modals"></div>

  <!-- Common JavaScript -->
  <script src="common.js"></script>

  <script>
    // ========== CHECKOUT PAGE VARIABLES ==========
    let subtotalSpan, shippingSpan, discountSpan, totalSpan;
    let standardRadio, expressRadio, freeBadge, standardPriceSpan, radioStandard, radioExpress;
    let cartItems = [];

    // ========== SCROLL HANDLER ==========
    function handleScroll() {
      const btn = document.getElementById('scrollTop');
      if (btn) btn.classList.toggle('visible', window.scrollY > 200);
    }
    window.addEventListener('scroll', handleScroll);

    // ========== CHECKOUT FUNCTIONS ==========
    function loadCartItems() {
      cartItems = JSON.parse(localStorage.getItem('MyEssantia_cart')) || [];
      
      const checkoutContent = document.getElementById('checkout-content');
      
      if (cartItems.length === 0) {
        checkoutContent.innerHTML = `
          <div class="empty-cart-checkout">
            <i class="fa-regular fa-cart-shopping"></i>
            <h3>Your cart is empty</h3>
            <p>Looks like you haven't added any items to your cart yet.</p>
            <a href="collection.html" class="btn">Continue Shopping</a>
          </div>
        `;
        return;
      }

      checkoutContent.innerHTML = renderCheckoutGrid();
      
      setTimeout(() => {
        initializeCheckout();
      }, 50);
    }

    function renderCheckoutGrid() {
      // Generate cart items HTML with working quantity controls
      const cartItemsHtml = cartItems.map((item, index) => {
        const itemTotal = item.price * item.quantity;
        const imageUrl = item.primaryImg || item.image || 'https://via.placeholder.com/60';
        
        return `
          <div class="cart-item" id="product-${item.id}" data-product-id="${item.id}">
            <div class="item-image" style="background-image: url('${imageUrl}');"></div>
            <div class="item-details">
              <div class="item-header">
                <h4 title="${item.title}">${item.title}</h4>
                <span class="item-price" id="price-${item.id}">₹${formatPrice(itemTotal)}</span>
              </div>
              <div class="item-meta">${item.category || 'Accessory'}</div>
              <div class="qty-control">
                <button class="qty-btn" onclick="updateItemQuantity(${item.id}, -1)" ${item.quantity <= 1 ? 'disabled' : ''}>−</button>
                <span class="qty-value" id="qty-${item.id}">${item.quantity}</span>
                <button class="qty-btn" onclick="updateItemQuantity(${item.id}, 1)">+</button>
                <button class="qty-btn remove-btn" onclick="removeItem(${item.id})" title="Remove item">
                  <i class="fa-solid fa-trash-can"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      return `
        <div class="checkout-grid">
          <!-- LEFT COLUMN -->
          <div class="left-column">
            <!-- contact information -->
            <div class="section-card">
              <div class="section-title"><span class="step-number">1</span> Contact</div>
              <div class="form-group full-width">
                <label>Email</label>
                <input type="email" id="contact-email" placeholder="your@email.com" value="${currentUser?.email || ''}">
              </div>
              <div class="checkbox-row">
                <input type="checkbox" id="offers" checked>
                <label for="offers">keep me updated on new arrivals & offers</label>
              </div>
            </div>

            <!-- shipping address -->
            <div class="section-card">
              <div class="section-title"><span class="step-number">2</span> Shipping address</div>
              <div class="form-row">
                <div class="form-group"><label>First name</label><input id="first-name" placeholder="First name"></div>
                <div class="form-group"><label>Last name</label><input id="last-name" placeholder="Last name"></div>
              </div>
              <div class="form-group full-width"><label>Address</label><input id="address" placeholder="Street, building"></div>
              <div class="form-row">
                <div class="form-group"><label>City</label><input id="city" placeholder="City"></div>
                <div class="form-group"><label>PIN code</label><input id="pin" placeholder="PIN" type="number"></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>State</label>
                  <select id="state">
                    <option value="">Select state</option>
                    <option>Kerala</option>
                    <option>Tamil Nadu</option>
                    <option>Karnataka</option>
                    <option>Maharashtra</option>
                    <option>Delhi</option>
                  </select>
                </div>
                <div class="form-group"><label>Phone</label><input id="phone" placeholder="+91 98765 43210" type="tel"></div>
              </div>
            </div>

            <!-- shipping method -->
            <div class="section-card">
              <div class="section-title"><span class="step-number">3</span> Shipping method</div>
              
              <label class="radio-card selected" id="radio-standard">
                <input type="radio" name="shipping" value="standard" id="ship-standard" checked>
                <div class="radio-content">
                  <span>Standard shipping (3–5 days) <span class="free-badge" id="freeBadge" style="display: none;">FREE</span></span>
                  <span class="radio-price" id="standard-price">₹40</span>
                </div>
              </label>

              <label class="radio-card" id="radio-express">
                <input type="radio" name="shipping" value="express">
                <div class="radio-content">
                  <span>Express shipping (1–2 days)</span>
                  <span class="radio-price">₹149</span>
                </div>
              </label>
              <p style="font-size:0.7rem; margin-top:0.5rem; color:#666;"><i class="fa-solid fa-circle-info" style="color:#d4af37;"></i> Free standard shipping on orders above ₹499</p>
            </div>

            <!-- NEW TRUST & RETURN SECTION -->
            <div class="trust-section">
              <div class="trust-title">
                <i class="fa-solid fa-shield-halved"></i> 7-Day Easy Return
              </div>
              <div class="trust-grid">
                <div class="trust-item"><i class="fa-solid fa-circle-check success"></i> 7 days return window</div>
                <div class="trust-item"><i class="fa-solid fa-truck"></i> Free pick-up</div>
                <div class="trust-item"><i class="fa-solid fa-video"></i> Unboxing video required</div>
                <div class="trust-item"><i class="fa-solid fa-box-open"></i> Damaged goods only</div>
              </div>
              
              <div class="return-policy">
                <p><i class="fa-solid fa-circle-exclamation"></i> <strong>Return Policy:</strong></p>
                <ul>
                  <li>For damaged items only (shipping defects)</li>
                  <li>Must submit unboxing video as proof</li>
                  <li>Video must show damaged product clearly</li>
                  <li>Claim within 7 days of delivery</li>
                </ul>
                <div class="razorpay-badge">
                  <i class="fa-solid fa-bolt"></i> Razorpay 100% refund guarantee
                </div>
                <p style="font-size:0.65rem; margin-top:0.5rem; color:#666;">
                  <i class="fa-regular fa-clock"></i> Refund processed within 3-5 business days after approval
                </p>
              </div>
            </div>
          </div>

          <!-- RIGHT COLUMN - order summary -->
          <div class="right-column">
            <div class="order-summary">
              <div class="summary-title">your <span>cart</span></div>
              
              <!-- Scrollable cart items -->
              <div class="cart-items-container" id="cart-items-container">
                ${cartItemsHtml}
              </div>

              <!-- PROMO CODE SECTION -->
              <div class="promo-inside">
                <p>Apply promo code</p>
                <div class="promo-flex">
                  <input type="text" placeholder="Enter code" id="promo-code">
                  <button class="promo-btn" onclick="applyPromo()">Apply</button>
                </div>
              </div>

              <div style="margin: 0.3rem 0 0.8rem; border-top: 2px dashed #000;"></div>

              <!-- price breakdown -->
              <div class="price-line"><span>Subtotal</span> <span id="subtotal-value">₹0</span></div>
              <div class="price-line"><span>Shipping</span> <span id="shipping-value">₹0</span></div>
              <div class="price-line" style="color:#2e7d32;" id="discount-line"><span>Discount</span> <span id="discount-value">-₹0</span></div>

              <!-- total -->
              <div class="total-line">
                <span>Total</span> <span id="total-value">₹0</span>
              </div>

              <button class="place-order-btn" onclick="placeOrder()" id="place-order-btn">
                <i class="fa-solid fa-lock"></i> place order
              </button>

              <div class="payment-icons-sm">
                <i class="fa-brands fa-cc-visa"></i>
                <i class="fa-brands fa-cc-mastercard"></i>
                <i class="fa-brands fa-cc-amex"></i>
                <i class="fa-brands fa-cc-paypal"></i>
                <i class="fa-brands fa-cc-rupay"></i>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ===== QUANTITY CONTROL FUNCTIONS - FIXED =====
    window.updateItemQuantity = function(productId, change) {
      const itemIndex = cartItems.findIndex(item => item.id === productId);
      if (itemIndex === -1) return;

      const item = cartItems[itemIndex];
      const newQuantity = item.quantity + change;

      if (newQuantity < 1) return;
      
      // Update quantity
      item.quantity = newQuantity;
      
      // Update display
      const qtySpan = document.getElementById(`qty-${productId}`);
      if (qtySpan) qtySpan.innerText = newQuantity;
      
      // Update price
      const priceSpan = document.getElementById(`price-${productId}`);
      if (priceSpan) {
        priceSpan.innerText = '₹' + formatPrice(item.price * newQuantity);
      }
      
      // Enable/disable minus button
      const minusBtn = document.querySelector(`#product-${productId} .qty-btn:first-child`);
      if (minusBtn) {
        minusBtn.disabled = newQuantity <= 1;
      }
      
      // Save to localStorage
      localStorage.setItem('MyEssantia_cart', JSON.stringify(cartItems));
      
      // Update cart count
      updateCartCount();
      
      // Update totals
      updateAll();
    };

    window.removeItem = function(productId) {
      // Remove item from cart
      cartItems = cartItems.filter(item => item.id !== productId);
      
      // Save to localStorage
      localStorage.setItem('MyEssantia_cart', JSON.stringify(cartItems));
      
      // If cart is empty, reload page to show empty state
      if (cartItems.length === 0) {
        window.location.reload();
        return;
      }
      
      // Re-render cart items
      const container = document.getElementById('cart-items-container');
      if (container) {
        const newHtml = cartItems.map((item) => {
          const itemTotal = item.price * item.quantity;
          const imageUrl = item.primaryImg || item.image || 'https://via.placeholder.com/60';
          
          return `
            <div class="cart-item" id="product-${item.id}" data-product-id="${item.id}">
              <div class="item-image" style="background-image: url('${imageUrl}');"></div>
              <div class="item-details">
                <div class="item-header">
                  <h4 title="${item.title}">${item.title}</h4>
                  <span class="item-price" id="price-${item.id}">₹${formatPrice(itemTotal)}</span>
                </div>
                <div class="item-meta">${item.category || 'Accessory'}</div>
                <div class="qty-control">
                  <button class="qty-btn" onclick="updateItemQuantity(${item.id}, -1)" ${item.quantity <= 1 ? 'disabled' : ''}>−</button>
                  <span class="qty-value" id="qty-${item.id}">${item.quantity}</span>
                  <button class="qty-btn" onclick="updateItemQuantity(${item.id}, 1)">+</button>
                  <button class="qty-btn remove-btn" onclick="removeItem(${item.id})">
                    <i class="fa-solid fa-trash-can"></i>
                  </button>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        container.innerHTML = newHtml;
      }
      
      // Update cart count and totals
      updateCartCount();
      updateAll();
    };

    function initializeCheckout() {
      subtotalSpan = document.getElementById('subtotal-value');
      shippingSpan = document.getElementById('shipping-value');
      discountSpan = document.getElementById('discount-value');
      totalSpan = document.getElementById('total-value');
      
      standardRadio = document.getElementById('ship-standard');
      expressRadio = document.querySelector('input[name="shipping"][value="express"]');
      freeBadge = document.getElementById('freeBadge');
      standardPriceSpan = document.getElementById('standard-price');
      radioStandard = document.getElementById('radio-standard');
      radioExpress = document.getElementById('radio-express');

      // Radio change listeners
      document.querySelectorAll('input[name="shipping"]').forEach(radio => {
        radio.addEventListener('change', updateAll);
      });

      updateAll();
    }

    function formatPrice(price) {
      return price.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }

    function calculateSubtotal() {
      return cartItems.reduce((total, item) => {
        return total + (item.price * item.quantity);
      }, 0);
    }

    function updateAll() {
      const subtotal = calculateSubtotal();
      
      let shippingCost = 40;
      let shippingText = '₹40';
      const isExpress = expressRadio ? expressRadio.checked : false;
      
      if (subtotal > 499) {
        if (standardRadio && standardRadio.checked) {
          shippingCost = 0;
          shippingText = 'FREE';
        } else if (isExpress) {
          shippingCost = 149;
          shippingText = '₹149';
        }
        if (standardPriceSpan) standardPriceSpan.innerText = 'FREE';
        if (freeBadge) freeBadge.style.display = 'inline-block';
      } else {
        if (standardPriceSpan) standardPriceSpan.innerText = '₹40';
        if (freeBadge) freeBadge.style.display = 'none';
        if (standardRadio && standardRadio.checked) {
          shippingCost = 40;
          shippingText = '₹40';
        } else if (isExpress) {
          shippingCost = 149;
          shippingText = '₹149';
        }
      }

      if (isExpress) {
        shippingCost = 149;
        shippingText = '₹149';
      }

      if (shippingSpan) shippingSpan.innerText = shippingText;

      const discount = 0;
      if (discountSpan) discountSpan.innerText = '-₹' + discount;

      const total = subtotal - discount + shippingCost;
      if (subtotalSpan) subtotalSpan.innerText = '₹' + formatPrice(subtotal);
      if (totalSpan) totalSpan.innerText = '₹' + formatPrice(total);

      // Highlight selected radio card
      document.querySelectorAll('.radio-card').forEach(c => c.classList.remove('selected'));
      if (standardRadio && standardRadio.checked) {
        if (radioStandard) radioStandard.classList.add('selected');
      } else if (expressRadio && expressRadio.checked) {
        if (radioExpress) radioExpress.classList.add('selected');
      }
    }

    window.applyPromo = function() {
      const promoInput = document.getElementById('promo-code');
      if (promoInput && promoInput.value) {
        alert(`Promo code "${promoInput.value}" applied (demo)`);
      } else {
        alert('Please enter a promo code');
      }
    };

    window.placeOrder = function() {
      if (!currentUser) {
        alert('Please login to place your order');
        if (typeof openProfile === 'function') openProfile();
        return;
      }
      
      if (cartItems.length === 0) {
        alert('Your cart is empty!');
        return;
      }
      
      // Validate required fields
      const firstName = document.getElementById('first-name')?.value;
      const lastName = document.getElementById('last-name')?.value;
      const address = document.getElementById('address')?.value;
      const city = document.getElementById('city')?.value;
      const pin = document.getElementById('pin')?.value;
      const phone = document.getElementById('phone')?.value;
      
      if (!firstName || !lastName || !address || !city || !pin || !phone) {
        alert('Please fill in all shipping address fields');
        return;
      }
      
      // Create order object
      const order = {
        orderId: 'ORD' + Date.now().toString().slice(-8),
        userId: currentUser.uid,
        email: currentUser.email,
        date: new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }),
        status: 'processing',
        items: cartItems.map(item => ({
          id: item.id,
          name: item.title,
          qty: item.quantity,
          price: item.price,
          image: item.primaryImg || item.image
        })),
        subtotal: calculateSubtotal(),
        shipping: shippingSpan?.innerText === 'FREE' ? 0 : 40,
        total: parseFloat(totalSpan?.innerText.replace('₹', '').replace(/,/g, '')),
        shippingAddress: {
          firstName, lastName, address, city, pin, phone
        },
        timestamp: Date.now()
      };
      
      // Save to Firestore
      if (typeof db !== 'undefined') {
        db.collection('orders').add(order).then(() => {
          localStorage.removeItem('MyEssantia_cart');
          alert(`Order placed successfully! Order ID: ${order.orderId}\n\nThank you for shopping with MyEssantia!`);
          window.location.href = 'order-tracking.html';
        }).catch(error => {
          console.error('Error placing order:', error);
          alert('Failed to place order. Please try again.');
        });
      } else {
        // Demo mode
        alert(`DEMO: Order placed successfully!\nOrder ID: ${order.orderId}\n\nThank you for shopping!`);
        localStorage.removeItem('MyEssantia_cart');
        window.location.href = 'collection.html';
      }
    };

    function prefillUserData() {
      if (!currentUser) return;
      const emailInput = document.getElementById('contact-email');
      if (emailInput && currentUser.email) {
        emailInput.value = currentUser.email;
      }
    }

    // ========== INITIALIZATION ==========
    function initializeApp() {
      updateCartCount();
      updateProfileIcon();
      loadCartItems();
      
      const savedUser = localStorage.getItem('MyEssantia_user');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        updateProfileIcon();
        setTimeout(() => prefillUserData(), 100);
      }
    }

    async function loadCommonModals() {
      try {
        const response = await fetch('common.html');
        const data = await response.text();
        document.getElementById('common-modals').innerHTML = data;
      } catch (error) {
        console.error('Error loading common modals:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadCommonModals();
      if (typeof loadComponents === 'function') loadComponents();
    });
  </script>
</body>
</html>
