<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <title>ESSENCE · checkout · premium</title>
  
  <!-- Font Awesome 6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <!-- Premium Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300..700&family=Montserrat:wght@300..900&display=swap" rel="stylesheet">
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  
  <!-- Common CSS -->
  <link rel="stylesheet" href="common.css">
  <link rel="stylesheet" href="header.css">
  <link rel="stylesheet" href="footer.css">
  
  <style>
    /* ===== GLOBAL & RESETS ===== */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Inter', 'Montserrat', sans-serif; 
      background: #ffffff; 
      color: #1e1e1e; 
      overflow-x: hidden;
      line-height: 1.5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container { 
      width: 100%; 
      max-width: 1200px; /* Slightly reduced for better proportion */
      margin: 0 auto; 
      padding: 0 20px; 
    }
    @media (min-width: 640px) { .container { padding: 0 24px; } }
    @media (min-width: 1024px) { .container { padding: 0 32px; } }

    /* ===== CHECKOUT HEADER ===== */
    .checkout-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1.5rem 0 2rem; /* Reduced top margin */
      flex-wrap: wrap;
      gap: 1rem;
    }
    .checkout-header h1 {
      font-size: clamp(1.6rem, 4vw, 2rem); /* Slightly smaller */
      font-weight: 800;
      color: #000;
      text-transform: uppercase;
      letter-spacing: -0.02em;
      font-family: 'Montserrat', sans-serif;
      line-height: 1.2;
    }
    .checkout-header h1 span {
      color: #d4af37;
      font-weight: 900;
    }
    .secure-badge {
      background: #000;
      padding: 0.5rem 1.2rem; /* More compact */
      border-radius: 60px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
      color: #fff;
      border: 2px solid #d4af37;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .secure-badge i {
      color: #d4af37;
      margin-right: 0.3rem;
    }

    /* ===== EMPTY CART ===== */
    .empty-cart-checkout {
      text-align: center;
      padding: 3rem 1.5rem; /* Reduced padding */
      background: #ffffff;
      border-radius: 32px; /* Slightly smaller */
      border: 2px solid #000;
      box-shadow: 6px 6px 0 rgba(0,0,0,0.15); /* Slightly smaller shadow */
      margin: 1.5rem 0;
    }
    .empty-cart-checkout i {
      font-size: 3rem; /* Smaller */
      color: #d4af37;
      margin-bottom: 1rem;
    }
    .empty-cart-checkout h3 {
      font-family: 'Montserrat', sans-serif;
      font-size: 1.5rem; /* Smaller */
      font-weight: 800;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
    }
    .empty-cart-checkout p {
      color: #666;
      margin-bottom: 1.5rem; /* Reduced */
      font-size: 0.95rem;
    }
    .empty-cart-checkout .btn {
      display: inline-block;
      padding: 0.9rem 2.2rem; /* More compact */
      background: #000;
      color: #fff;
      text-decoration: none;
      border-radius: 60px;
      font-weight: 600;
      transition: all 0.2s;
      border: 2px solid #000;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.9rem;
    }
    .empty-cart-checkout .btn:hover {
      background: #d4af37;
      color: #000;
      border-color: #d4af37;
    }

    /* ===== MAIN CHECKOUT GRID ===== */
    .checkout-grid {
      display: grid;
      grid-template-columns: 1.2fr 0.9fr; /* Adjusted ratio */
      gap: 1.8rem; /* Slightly smaller gap */
      align-items: start;
      margin-bottom: 3rem;
    }

    /* ===== SECTION CARDS ===== */
    .section-card {
      background: #ffffff;
      border-radius: 28px; /* Smaller radius */
      padding: 1.5rem; /* More compact padding */
      border: 2px solid #000;
      box-shadow: 6px 6px 0 rgba(0,0,0,0.12); /* Smaller shadow */
      margin-bottom: 1.5rem; /* Reduced margin */
    }
    .section-title {
      font-size: 1.3rem; /* Fixed size */
      font-weight: 800;
      margin-bottom: 1.2rem; /* Reduced */
      display: flex;
      align-items: center;
      gap: 0.8rem;
      font-family: 'Montserrat', sans-serif;
      text-transform: uppercase;
      letter-spacing: -0.02em;
      flex-wrap: wrap;
    }
    .section-title .step-number {
      background: #000;
      color: #d4af37;
      width: 34px; /* Slightly smaller */
      height: 34px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 1.1rem;
      border: 2px solid #d4af37;
    }

    /* ===== FORM STYLES ===== */
    .form-row {
      display: flex;
      gap: 1rem; /* Reduced gap */
      margin-bottom: 1rem; /* Reduced margin */
      flex-wrap: wrap;
    }
    .form-group {
      flex: 1 1 calc(50% - 0.5rem);
      min-width: 140px;
    }
    .form-group.full-width {
      flex: 1 1 100%;
    }
    label {
      display: block;
      font-size: 0.65rem; /* Smaller */
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #000;
      margin-bottom: 0.3rem;
      font-weight: 600;
    }
    input, select {
      width: 100%;
      padding: 0.8rem 1.2rem; /* More compact */
      border: 2px solid #000;
      border-radius: 50px; /* Slightly smaller radius */
      background: #ffffff;
      font-size: 0.9rem;
      transition: 0.2s;
      outline: none;
      font-family: 'Inter', sans-serif;
      font-weight: 400;
    }
    input:focus, select:focus {
      border-color: #d4af37;
      box-shadow: 0 0 0 3px rgba(212,175,55,0.15);
    }

    /* ===== CHECKBOX ROW ===== */
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      margin-top: 0.6rem;
      flex-wrap: wrap;
    }
    .checkbox-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #d4af37;
      margin: 0;
    }
    .checkbox-row label {
      display: inline;
      text-transform: none;
      font-size: 0.85rem; /* Smaller */
      color: #1e1e1e;
      margin: 0;
      font-weight: 400;
    }

    /* ===== SHIPPING METHOD RADIO CARDS ===== */
    .radio-card {
      border: 2px solid #000;
      border-radius: 50px;
      padding: 0.9rem 1.2rem; /* More compact */
      margin-bottom: 0.7rem; /* Reduced */
      display: flex;
      align-items: center;
      gap: 0.8rem;
      transition: 0.15s;
      cursor: pointer;
      flex-wrap: wrap;
      background: #ffffff;
    }
    .radio-card.selected {
      border-color: #d4af37;
      background: #fcf9f4;
      box-shadow: 0 0 0 2px #d4af37;
    }
    .radio-card input[type="radio"] {
      width: 16px;
      height: 16px;
      accent-color: #d4af37;
      margin: 0;
      flex-shrink: 0;
    }
    .radio-content {
      flex: 1;
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem; /* Smaller */
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      font-weight: 500;
    }
    .radio-price {
      font-weight: 700;
      color: #000;
      white-space: nowrap;
    }
    .free-badge {
      background: #2e7d32;
      color: white;
      font-size: 0.65rem; /* Smaller */
      padding: 0.15rem 0.6rem;
      border-radius: 40px;
      margin-left: 0.5rem;
      font-weight: 700;
      white-space: nowrap;
      border: 1px solid #000;
    }

    /* ===== RIGHT PANEL - order summary ===== */
    .order-summary {
      background: #ffffff;
      border-radius: 32px; /* Slightly smaller */
      padding: 1.5rem; /* More compact */
      border: 2px solid #000;
      box-shadow: 6px 6px 0 rgba(0,0,0,0.15);
      position: sticky;
      top: 20px;
    }
    .summary-title {
      font-size: 1.4rem; /* Smaller */
      font-weight: 800;
      border-bottom: 3px solid #000;
      padding-bottom: 1rem; /* Reduced */
      margin-bottom: 1.2rem; /* Reduced */
      font-family: 'Montserrat', sans-serif;
      text-transform: uppercase;
      letter-spacing: -0.02em;
    }
    .summary-title span {
      color: #d4af37;
      font-weight: 900;
    }

    /* ===== CART ITEMS ===== */
    .cart-item {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.2rem; /* Reduced */
      align-items: center;
      flex-wrap: wrap;
    }
    .item-image {
      width: 70px; /* Smaller */
      height: 70px;
      background: #ece5dc;
      border-radius: 18px; /* Slightly smaller */
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
      border: 2px solid #000;
      box-shadow: 3px 3px 0 rgba(0,0,0,0.1);
    }
    .item-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 160px; /* Slightly smaller */
    }
    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      width: 100%;
      gap: 0.8rem;
      flex-wrap: wrap;
    }
    .item-details h4 {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      font-size: 0.95rem; /* Smaller */
      color: #000;
      text-transform: uppercase;
      line-height: 1.3;
    }
    .item-price {
      font-weight: 800;
      color: #d4af37;
      font-size: 0.95rem; /* Smaller */
      white-space: nowrap;
    }
    .item-meta {
      font-size: 0.65rem; /* Smaller */
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin: 0.1rem 0 0.3rem;
      font-weight: 600;
    }
    .qty-control {
      display: flex;
      align-items: center;
      gap: 0.4rem; /* Smaller */
      margin-top: 0.2rem;
      flex-wrap: wrap;
    }
    .qty-btn {
      background: #f5f2ee;
      border: 2px solid #000;
      width: 28px; /* Smaller */
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.9rem;
      transition: 0.1s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .qty-btn:hover {
      background: #d4af37;
      color: #000;
    }

    /* ===== PROMO INSIDE ===== */
    .promo-inside {
      background: #f8f5f1;
      border-radius: 24px; /* Smaller */
      padding: 1rem 1.2rem; /* More compact */
      margin: 1.2rem 0 1rem; /* Reduced */
      border: 2px solid #000;
      box-shadow: 3px 3px 0 rgba(0,0,0,0.1);
    }
    .promo-inside p {
      font-weight: 700;
      margin-bottom: 0.6rem; /* Reduced */
      font-size: 0.8rem; /* Smaller */
      text-transform: uppercase;
    }
    .promo-flex {
      display: flex;
      gap: 0.6rem; /* Smaller */
      align-items: center;
      flex-wrap: wrap;
    }
    .promo-flex input {
      flex: 1;
      min-width: 140px; /* Smaller */
      background: white;
      border: 2px solid #000;
      padding: 0.7rem 1rem; /* More compact */
      border-radius: 50px;
      font-size: 0.85rem;
    }
    .promo-btn {
      background: #000;
      border: 2px solid #000;
      color: white;
      padding: 0.7rem 1.4rem; /* More compact */
      border-radius: 50px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
      font-family: 'Inter', sans-serif;
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.8rem; /* Smaller */
    }
    .promo-btn:hover {
      background: #d4af37;
      color: #000;
      border-color: #d4af37;
    }

    /* ===== PRICE BREAKDOWN ===== */
    .price-line {
      display: flex;
      justify-content: space-between;
      margin: 0.5rem 0; /* Reduced */
      font-size: 0.9rem; /* Smaller */
      font-weight: 500;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .total-line {
      font-weight: 800;
      font-size: 1.4rem; /* Smaller */
      border-top: 3px solid #000;
      padding-top: 1rem; /* Reduced */
      margin: 0.8rem 0 1.2rem; /* Reduced */
      font-family: 'Montserrat', sans-serif;
      color: #000;
      letter-spacing: -0.01em;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }

    /* ===== PLACE ORDER BUTTON ===== */
    .place-order-btn {
      background: #d4af37;
      border: 2px solid #000;
      width: 100%;
      padding: 1.2rem; /* More compact */
      border-radius: 50px;
      font-weight: 700;
      font-size: 1rem; /* Smaller */
      color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.6rem;
      cursor: pointer;
      transition: 0.2s;
      margin-bottom: 1rem; /* Reduced */
      font-family: 'Montserrat', sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 4px 4px 0 rgba(0,0,0,0.15);
    }
    .place-order-btn:hover:not(:disabled) {
      background: #000;
      color: #d4af37;
      border-color: #d4af37;
      transform: translateY(-2px);
      box-shadow: 5px 5px 0 rgba(0,0,0,0.15);
    }

    /* ===== PAYMENT ICONS ===== */
    .payment-icons-sm {
      display: flex;
      justify-content: center;
      gap: 0.8rem; /* Smaller */
      color: #000;
      font-size: 1.4rem; /* Smaller */
      flex-wrap: wrap;
    }
    .notice {
      font-size: 0.7rem; /* Smaller */
      text-align: center;
      margin-top: 0.8rem; /* Reduced */
      color: #666;
      font-weight: 500;
    }
    .notice i {
      color: #d4af37;
      margin-right: 0.2rem;
    }

    /* ===== RESPONSIVE BREAKPOINTS ===== */
    @media (max-width: 992px) {
      .checkout-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem; /* Smaller gap */
      }
      .order-summary {
        position: static;
        max-width: 650px; /* Slightly smaller */
        margin: 0 auto;
      }
    }

    @media (max-width: 768px) {
      .checkout-header {
        margin: 1rem 0 1.5rem; /* Smaller on mobile */
      }
      .form-group {
        flex: 1 1 100%;
      }
      .radio-card {
        padding: 0.8rem 1rem; /* More compact */
      }
      .radio-content {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.3rem;
      }
      .cart-item {
        flex-direction: column;
        align-items: flex-start;
      }
      .item-image {
        width: 100%;
        height: 160px; /* Smaller on mobile */
      }
      .promo-flex {
        flex-direction: column;
        align-items: stretch;
      }
      .promo-btn {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      .checkout-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .secure-badge {
        align-self: flex-start;
      }
      .section-title {
        font-size: 1.2rem; /* Smaller */
      }
      .section-title .step-number {
        width: 30px;
        height: 30px;
        font-size: 1rem;
      }
      .item-image {
        height: 140px; /* Even smaller */
      }
      .summary-title {
        font-size: 1.3rem;
      }
      .total-line {
        font-size: 1.3rem;
      }
    }

    @media (max-width: 360px) {
      .container {
        padding: 0 12px; /* Smaller padding */
      }
      .item-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.3rem;
      }
      .qty-control {
        width: 100%;
        justify-content: flex-start;
      }
    }

    /* ===== SCROLL TOP BUTTON ===== */
    .scroll-top {
      position: fixed; 
      bottom: 16px; 
      right: 16px; 
      background: #000; 
      color: #d4af37; 
      width: 44px; /* Smaller */
      height: 44px; 
      border-radius: 50%;
      display: flex; 
      align-items: center; 
      justify-content: center; 
      border: 2px solid #d4af37; 
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
      opacity: 0; 
      transform: translateY(15px); 
      transition: 0.2s; 
      z-index: 100;
      font-size: 1.2rem; /* Smaller */
      cursor: pointer;
    }
    .scroll-top.visible { 
      opacity: 1; 
      transform: translateY(0); 
    }
    .scroll-top:hover { 
      background: #d4af37; 
      color: #000; 
      border-color: #000; 
    }
  </style>
</head>
<body>
  
  <!-- Header loaded dynamically -->
  <div id="header"></div>
  
  <!-- Scroll to top button -->
  <button class="scroll-top" id="scrollTop" onclick="window.scrollTo({top:0,behavior:'smooth'})"><i class="fa-solid fa-arrow-up"></i></button>

  <main>
    <div class="container">
      <!-- checkout header -->
      <div class="checkout-header">
        <h1>checkout <span>· essence</span></h1>
        <div class="secure-badge"><i class="fa-solid fa-lock"></i> secure checkout</div>
      </div>

      <!-- Cart items will be loaded dynamically from localStorage -->
      <div id="checkout-content"></div>
    </div>
  </main>

  <!-- Footer loaded dynamically -->
  <div id="footer"></div>

  <!-- Common Modals -->
  <div id="common-modals"></div>

  <!-- Common JavaScript -->
  <script src="common.js"></script>

  <script>
    // ========== CHECKOUT PAGE SPECIFIC VARIABLES ==========
    let subtotalSpan, shippingSpan, discountSpan, totalSpan;
    let standardRadio, expressRadio, freeBadge, standardPriceSpan, radioStandard, radioExpress;
    let cartItems = [];

    // ========== SCROLL HANDLER FOR SCROLL TOP BUTTON ==========
    function handleScroll() {
      const btn = document.getElementById('scrollTop');
      if (btn) btn.classList.toggle('visible', window.scrollY > 200);
    }
    window.addEventListener('scroll', handleScroll);

    // ========== CHECKOUT FUNCTIONS ==========
    function loadCartItems() {
      // Get cart from localStorage
      cartItems = JSON.parse(localStorage.getItem('MyEssantia_cart')) || [];
      
      const checkoutContent = document.getElementById('checkout-content');
      
      if (cartItems.length === 0) {
        // Show empty cart message
        checkoutContent.innerHTML = `
          <div class="empty-cart-checkout">
            <i class="fa-regular fa-cart-shopping"></i>
            <h3>Your cart is empty</h3>
            <p>Looks like you haven't added any items to your cart yet.</p>
            <a href="collection.html" class="btn">Continue Shopping</a>
          </div>
        `;
        return;
      }

      // Render checkout grid with cart items
      checkoutContent.innerHTML = renderCheckoutGrid();
      
      // Initialize checkout after rendering
      setTimeout(() => {
        initializeCheckout();
      }, 50);
    }

    function renderCheckoutGrid() {
      // Generate cart items HTML
      const cartItemsHtml = cartItems.map((item, index) => {
        const itemTotal = item.price * item.quantity;
        const imageUrl = item.primaryImg || item.image || 'https://via.placeholder.com/80';
        
        return `
          <div class="cart-item" id="product-${item.id}" data-price="${item.price}" data-index="${index}">
            <div class="item-image" style="background-image: url('${imageUrl}');"></div>
            <div class="item-details">
              <div class="item-header">
                <h4>${item.title}</h4>
                <span class="item-price" id="price-${item.id}-display">₹${formatPrice(itemTotal)}</span>
              </div>
              <div class="item-meta">${item.category || 'Accessory'}</div>
              <div class="qty-control">
                <button class="qty-btn" data-product="${item.id}" data-delta="-1">−</button>
                <span style="font-size: 0.85rem; font-weight: 600;" id="qty-${item.id}">${item.quantity}</span>
                <button class="qty-btn" data-product="${item.id}" data-delta="1">+</button>
                <button class="qty-btn" data-product="${item.id}" data-delta="remove" style="background: #fee; color: #c00; margin-left: 0.5rem;" title="Remove item">
                  <i class="fa-solid fa-trash-can" style="font-size: 0.75rem;"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      return `
        <!-- main grid -->
        <div class="checkout-grid">
          <!-- LEFT COLUMN: contact, shipping address, shipping method -->
          <div>
            <!-- contact information -->
            <div class="section-card">
              <div class="section-title"><span class="step-number">1</span> Contact</div>
              <div class="form-group full-width">
                <label>Email</label>
                <input type="email" id="contact-email" placeholder="your@email.com" value="${currentUser?.email || ''}">
              </div>
              <div class="checkbox-row">
                <input type="checkbox" id="offers" checked>
                <label for="offers">keep me updated on new arrivals & offers</label>
              </div>
            </div>

            <!-- shipping address -->
            <div class="section-card">
              <div class="section-title"><span class="step-number">2</span> Shipping address</div>
              <div class="form-row">
                <div class="form-group"><label>First name</label><input id="first-name" placeholder="First name" value=""></div>
                <div class="form-group"><label>Last name</label><input id="last-name" placeholder="Last name" value=""></div>
              </div>
              <div class="form-group full-width"><label>Address</label><input id="address" placeholder="Street, building" value=""></div>
              <div class="form-row">
                <div class="form-group"><label>City</label><input id="city" placeholder="City" value=""></div>
                <div class="form-group"><label>PIN code</label><input id="pin" placeholder="PIN" value=""></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>State</label>
                  <select id="state">
                    <option>Select state</option>
                    <option>Kerala</option>
                    <option>Tamil Nadu</option>
                    <option>Karnataka</option>
                    <option>Maharashtra</option>
                    <option>Delhi</option>
                  </select>
                </div>
                <div class="form-group"><label>Phone</label><input id="phone" placeholder="+91 ..." value=""></div>
              </div>
            </div>

            <!-- shipping method -->
            <div class="section-card">
              <div class="section-title"><span class="step-number">3</span> Shipping method</div>
              
              <label class="radio-card selected" id="radio-standard">
                <input type="radio" name="shipping" value="standard" id="ship-standard" checked>
                <div class="radio-content">
                  <span>Standard shipping (3–5 days) <span class="free-badge" id="freeBadge" style="display: none;">FREE</span></span>
                  <span class="radio-price" id="standard-price">₹40</span>
                </div>
              </label>

              <label class="radio-card" id="radio-express">
                <input type="radio" name="shipping" value="express">
                <div class="radio-content">
                  <span>Express (1–2 days)</span>
                  <span class="radio-price">₹149</span>
                </div>
              </label>
              <p style="font-size:0.7rem; margin-top:0.6rem; color:#666; font-weight:500;"><i class="fa-solid fa-circle-info" style="color:#d4af37;"></i> Standard shipping becomes FREE on orders above ₹499</p>
            </div>
          </div>

          <!-- RIGHT COLUMN: order summary -->
          <div>
            <div class="order-summary">
              <div class="summary-title">your <span>cart</span></div>
              
              ${cartItemsHtml}

              <!-- PROMO CODE SECTION -->
              <div class="promo-inside">
                <p>Apply promo code</p>
                <div class="promo-flex">
                  <input type="text" placeholder="Enter code" id="promo-code">
                  <button class="promo-btn" onclick="applyPromo()">Apply</button>
                </div>
              </div>

              <div style="margin: 0.3rem 0 0.8rem; border-top: 2px dashed #000;"></div>

              <!-- dynamic price lines -->
              <div class="price-line"><span>Subtotal</span> <span id="subtotal-value">₹0</span></div>
              <div class="price-line"><span>Shipping</span> <span id="shipping-value">₹0</span></div>
              <div class="price-line" style="color:#2e7d32;" id="discount-line"><span>Discount</span> <span id="discount-value">-₹0</span></div>

              <!-- total -->
              <div class="total-line">
                <span>Total</span> <span id="total-value">₹0</span>
              </div>

              <button class="place-order-btn" onclick="placeOrder()" id="place-order-btn">
                <i class="fa-solid fa-lock"></i> place order
              </button>

              <div class="payment-icons-sm">
                <i class="fa-brands fa-cc-visa"></i>
                <i class="fa-brands fa-cc-mastercard"></i>
                <i class="fa-brands fa-cc-amex"></i>
                <i class="fa-brands fa-cc-paypal"></i>
                <i class="fa-regular fa-credit-card"></i>
              </div>
              <div class="notice">
                <i class="fa-regular fa-circle-check"></i> No-returns · secure checkout
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function initializeCheckout() {
      // Get DOM elements
      subtotalSpan = document.getElementById('subtotal-value');
      shippingSpan = document.getElementById('shipping-value');
      discountSpan = document.getElementById('discount-value');
      totalSpan = document.getElementById('total-value');
      
      standardRadio = document.getElementById('ship-standard');
      expressRadio = document.querySelector('input[name="shipping"][value="express"]');
      freeBadge = document.getElementById('freeBadge');
      standardPriceSpan = document.getElementById('standard-price');
      radioStandard = document.getElementById('radio-standard');
      radioExpress = document.getElementById('radio-express');

      // Quantity button handlers
      document.querySelectorAll('.qty-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          const delta = this.getAttribute('data-delta');
          const productId = this.getAttribute('data-product');
          if (!productId) return;
          
          if (delta === 'remove') {
            removeFromCart(parseInt(productId));
            return;
          }
          
          const deltaNum = parseInt(delta);
          updateCartItemQuantity(parseInt(productId), deltaNum);
        });
      });

      // Radio change listeners
      document.querySelectorAll('input[name="shipping"]').forEach(radio => {
        radio.addEventListener('change', updateAll);
      });

      // Initial update
      updateAll();
    }

    function updateCartItemQuantity(productId, change) {
      const itemIndex = cartItems.findIndex(item => item.id === productId);
      if (itemIndex === -1) return;

      const item = cartItems[itemIndex];
      const newQuantity = item.quantity + change;

      if (newQuantity <= 0) {
        // Remove item
        cartItems.splice(itemIndex, 1);
        const productElement = document.getElementById(`product-${productId}`);
        if (productElement) {
          productElement.remove();
        }
      } else {
        // Update quantity
        item.quantity = newQuantity;
        const qtySpan = document.getElementById(`qty-${productId}`);
        if (qtySpan) {
          qtySpan.innerText = newQuantity;
        }
        
        // Update price display
        const priceSpan = document.getElementById(`price-${productId}-display`);
        if (priceSpan) {
          const itemTotal = item.price * newQuantity;
          priceSpan.innerText = '₹' + formatPrice(itemTotal);
        }
      }

      // Save to localStorage
      localStorage.setItem('MyEssantia_cart', JSON.stringify(cartItems));
      
      // Update cart count in header
      updateCartCount();
      
      // Check if cart is empty
      if (cartItems.length === 0) {
        // Reload page to show empty cart message
        window.location.reload();
      } else {
        updateAll();
      }
    }

    window.removeFromCart = function(productId) {
      updateCartItemQuantity(productId, -Infinity);
    };

    function formatPrice(price) {
      return price.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }

    function calculateSubtotal() {
      return cartItems.reduce((total, item) => {
        return total + (item.price * item.quantity);
      }, 0);
    }

    function updateAll() {
      const subtotal = calculateSubtotal();
      
      // Determine shipping
      let shippingCost = 40;
      let shippingText = '₹40';
      const isExpress = expressRadio ? expressRadio.checked : false;
      
      if (subtotal > 499) {
        if (standardRadio && standardRadio.checked) {
          shippingCost = 0;
          shippingText = 'FREE';
        } else if (isExpress) {
          shippingCost = 149;
          shippingText = '₹149';
        }
        if (standardPriceSpan) standardPriceSpan.innerText = 'FREE';
        if (freeBadge) freeBadge.style.display = 'inline-block';
      } else {
        if (standardPriceSpan) standardPriceSpan.innerText = '₹40';
        if (freeBadge) freeBadge.style.display = 'none';
        if (standardRadio && standardRadio.checked) {
          shippingCost = 40;
          shippingText = '₹40';
        } else if (isExpress) {
          shippingCost = 149;
          shippingText = '₹149';
        }
      }

      if (isExpress) {
        shippingCost = 149;
        shippingText = '₹149';
      }

      if (shippingSpan) shippingSpan.innerText = shippingText;

      const discount = 0;
      if (discountSpan) discountSpan.innerText = '-₹' + discount;

      const total = subtotal - discount + shippingCost;
      if (subtotalSpan) subtotalSpan.innerText = '₹' + formatPrice(subtotal);
      if (totalSpan) totalSpan.innerText = '₹' + formatPrice(total);

      // Highlight selected radio card
      document.querySelectorAll('.radio-card').forEach(c => c.classList.remove('selected'));
      if (standardRadio && standardRadio.checked) {
        if (radioStandard) radioStandard.classList.add('selected');
      } else if (expressRadio && expressRadio.checked) {
        if (radioExpress) radioExpress.classList.add('selected');
      }
    }

    window.applyPromo = function() {
      const promoInput = document.getElementById('promo-code');
      if (promoInput && promoInput.value) {
        alert(`Promo code "${promoInput.value}" applied (demo)`);
      } else {
        alert('Please enter a promo code');
      }
    };

    window.placeOrder = function() {
      if (!currentUser) {
        alert('Please login to place your order');
        openProfile();
        return;
      }
      
      if (cartItems.length === 0) {
        alert('Your cart is empty!');
        return;
      }
      
      // Validate required fields
      const firstName = document.getElementById('first-name').value;
      const lastName = document.getElementById('last-name').value;
      const address = document.getElementById('address').value;
      const city = document.getElementById('city').value;
      const pin = document.getElementById('pin').value;
      const phone = document.getElementById('phone').value;
      
      if (!firstName || !lastName || !address || !city || !pin || !phone) {
        alert('Please fill in all shipping address fields');
        return;
      }
      
      // Create order object
      const order = {
        orderId: 'ORD' + Date.now().toString().slice(-8),
        userId: currentUser.uid,
        email: currentUser.email,
        date: new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }),
        status: 'processing',
        items: cartItems.map(item => ({
          id: item.id,
          name: item.title,
          qty: item.quantity,
          price: item.price,
          image: item.primaryImg || item.image
        })),
        total: calculateSubtotal(),
        shippingAddress: {
          firstName, lastName, address, city, pin, phone
        },
        timestamp: Date.now()
      };
      
      // Save to Firestore
      db.collection('orders').add(order).then(() => {
        // Clear cart
        localStorage.removeItem('MyEssantia_cart');
        
        alert(`Order placed successfully! Order ID: ${order.orderId}\n\nThank you for shopping with MyEssantia!`);
        
        // Redirect to order tracking
        window.location.href = 'order-tracking.html';
      }).catch(error => {
        console.error('Error placing order:', error);
        alert('Failed to place order. Please try again.');
      });
    };

    function prefillUserData() {
      if (!currentUser) return;
      
      // Pre-fill email field
      const emailInput = document.getElementById('contact-email');
      if (emailInput && currentUser.email) {
        emailInput.value = currentUser.email;
      }
    }

    // ========== INITIALIZATION ==========
    function initializeApp() {
      updateCartCount();
      updateProfileIcon();
      loadCartItems();
      
      const savedUser = localStorage.getItem('MyEssantia_user');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        updateProfileIcon();
        setTimeout(() => prefillUserData(), 100);
      }
    }

    // Load common modals
    async function loadCommonModals() {
      try {
        const response = await fetch('common.html');
        const data = await response.text();
        document.getElementById('common-modals').innerHTML = data;
      } catch (error) {
        console.error('Error loading common modals:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadCommonModals();
      loadComponents();
    });
  </script>
</body>
</html>
