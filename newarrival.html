<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <title>ESSENCE · new arrivals (premium)</title>
  
  <!-- Font Awesome 6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <!-- Premium Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400&family=Plus+Jakarta+Sans:wght@200;300;400;500;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  
  <!-- Common CSS -->
  <link rel="stylesheet" href="common.css">
  <link rel="stylesheet" href="header.css">
  <link rel="stylesheet" href="footer.css">
  
  <style>
    /* -------------------- NEW ARRIVALS PAGE SPECIFIC STYLES -------------------- */
    .page-title {
      text-align: center;
      padding: clamp(1.5rem, 4vw, 2rem) 0 clamp(0.5rem, 2vw, 1rem);
    }
    .page-title h1 {
      font-size: clamp(2.2rem, 6vw, 3.2rem);
      font-weight: 400;
      color: #1a1a1a;
      line-height: 1.2;
    }
    .page-title h1 span {
      color: #d4af37;
      font-weight: 500;
      font-style: italic;
    }
    .page-title p {
      color: #5f5b57;
      max-width: 600px;
      margin: 1rem auto 0;
      font-size: clamp(0.95rem, 2.5vw, 1.1rem);
      padding: 0 1rem;
    }

    /* New arrivals counter */
    .new-counter {
      text-align: center;
      margin: 1rem 0 2rem;
      font-size: 1rem;
      color: #666;
    }
    .new-counter span {
      background: #d4af37;
      color: #0c0c0c;
      padding: 0.3rem 1rem;
      border-radius: 40px;
      font-weight: 600;
      display: inline-block;
    }

    .sort-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 1.5rem 0 1rem;
      border-bottom: 1px solid #f0f0f0;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .sort-select {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: #fafafa;
      padding: 0.5rem 1.2rem;
      border-radius: 40px;
      border: 1px solid #eaeaea;
      cursor: pointer;
      transition: 0.2s;
      width: fit-content;
    }
    .sort-select:hover {
      border-color: #d4af37;
    }
    .sort-select i {
      color: #d4af37;
      font-size: 1rem;
    }
    .sort-select select {
      background: transparent;
      border: none;
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 0.9rem;
      font-weight: 400;
      color: #1a1a1a;
      outline: none;
      cursor: pointer;
    }

    .product-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: clamp(1rem, 2.5vw, 2rem);
      margin: 2rem 0 4rem;
    }

    .product-card {
      background: #fff;
      border-radius: 28px;
      padding: 1.2rem 1rem 1.8rem;
      box-shadow: 0 8px 22px -8px rgba(0,0,0,0.05);
      transition: all 0.25s ease;
      text-align: center;
      border: 1px solid #f5f5f5;
      display: flex;
      flex-direction: column;
      height: 100%;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      position: relative;
    }
    .product-card:hover {
      box-shadow: 0 20px 30px -12px rgba(0,0,0,0.15);
      border-color: #d4af37;
      transform: translateY(-6px);
    }

    .image-frame {
      position: relative;
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 24px;
      overflow: hidden;
      margin-bottom: 1.5rem;
      background-color: #f4f2ef;
    }

    .primary-img, .secondary-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      transition: opacity 0.35s ease;
    }

    .primary-img {
      opacity: 1;
      z-index: 2;
    }
    .secondary-img {
      opacity: 0;
      z-index: 1;
    }
    .image-frame:hover .primary-img {
      opacity: 0;
    }
    .image-frame:hover .secondary-img {
      opacity: 1;
    }

    .image-actions {
      position: absolute;
      bottom: 16px;
      left: 0;
      width: 100%;
      display: flex;
      gap: 10px;
      justify-content: center;
      padding: 0 12px;
      z-index: 10;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      pointer-events: none;
    }
    .image-frame:hover .image-actions {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .img-add, .img-buy {
      flex: 1;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(4px);
      border: none;
      border-radius: 40px;
      padding: 0.7rem 0.2rem;
      font-size: 0.8rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid rgba(0,0,0,0.1);
      color: #1a1a1a;
      font-family: 'Plus Jakarta Sans', sans-serif;
      pointer-events: auto;
    }
    .img-add i, .img-buy i {
      font-size: 0.85rem;
    }
    .img-add:hover {
      background: #ffffff;
      border-color: #d4af37;
      transform: scale(1.03);
    }
    .img-buy {
      background: rgba(212,175,55,0.9);
      color: #0c0c0c;
      border-color: #d4af37;
    }
    .img-buy:hover {
      background: #d4af37;
      transform: scale(1.03);
      box-shadow: 0 4px 10px rgba(212,175,55,0.3);
    }

    .product-title {
      font-family: 'Montserrat', sans-serif;
      font-weight: 500;
      font-size: clamp(1.1rem, 2vw, 1.3rem);
      margin-bottom: 0.3rem;
      color: #1e1e1e;
      letter-spacing: -0.01em;
    }

    .product-category {
      font-size: 0.75rem;
      color: #a2a2a2;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.4rem;
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-weight: 300;
    }

    .product-rating {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      margin: 0.3rem 0 0.3rem;
      flex-wrap: wrap;
    }
    .product-rating i {
      color: #d4af37;
      font-size: 0.9rem;
    }
    .product-rating span {
      margin-left: 4px;
      color: #5f5b57;
      font-size: 0.8rem;
      font-weight: 300;
    }

    .product-price {
      color: #d4af37;
      font-weight: 600;
      font-size: clamp(1.4rem, 3vw, 1.6rem);
      margin: 0.4rem 0 0.2rem;
      font-family: 'Montserrat', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 2px;
    }
    .product-price .inr-symbol {
      font-size: clamp(1.2rem, 2.5vw, 1.4rem);
      font-weight: 500;
      margin-right: 2px;
    }

    .new-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      background: #d4af37;
      color: #1a1a1a;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.3rem 0.8rem;
      border-radius: 30px;
      z-index: 20;
      letter-spacing: 0.3px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .sale-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #ff4444;
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.3rem 0.8rem;
      border-radius: 30px;
      z-index: 20;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .original-price {
      color: #999;
      font-size: 1rem;
      text-decoration: line-through;
      margin-right: 0.5rem;
    }

    .stock-badge {
      display: inline-block;
      padding: 0.2rem 0.8rem;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-top: 0.5rem;
    }
    .in-stock {
      background: #e3f1e3;
      color: #1e7a44;
    }
    .low-stock {
      background: #fff0db;
      color: #b85b1a;
    }
    .out-of-stock {
      background: #ffebee;
      color: #b71c1c;
    }

    .results-count {
      text-align: center;
      color: #666;
      margin: 1rem 0;
      font-size: 0.9rem;
    }

    @media (min-width: 1200px) {
      .container {
        padding: 0 3rem;
      }
      .page-title h1 {
        font-size: 3.2rem;
      }
    }

    @media (max-width: 992px) {
      .product-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
      }
    }

    @media (max-width: 768px) {
      .product-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1.2rem;
      }
      .container {
        padding: 0 1.5rem;
      }
      .page-title h1 {
        font-size: clamp(2rem, 7vw, 2.8rem);
      }
      .sort-bar {
        justify-content: center;
      }
    }

    @media (max-width: 480px) {
      .product-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      .container {
        padding: 0 1rem;
      }
      .sort-bar {
        justify-content: stretch;
      }
      .sort-select {
        width: 100%;
        justify-content: center;
      }
      .sort-select select {
        flex: 1;
      }
      .product-card {
        padding: 1rem 0.8rem 1.5rem;
      }
    }

    @media (max-width: 360px) {
      .image-actions {
        flex-direction: column;
        gap: 6px;
        bottom: 10px;
      }
      .img-add, .img-buy {
        padding: 0.5rem;
        font-size: 0.75rem;
      }
    }

    img {
      max-width: 100%;
      height: auto;
      display: block;
    }
  </style>
</head>
<body class="bg-noise">
  
  <!-- Header loaded dynamically -->
  <div id="header"></div>

  <main>
    <div class="container page-title">
      <h1>new <span>arrivals</span></h1>
      <p>Fresh drops — discover the latest accessories & essentials.</p>
    </div>

    <div class="container">
      <div id="new-counter" class="new-counter">
        <span><i class="fa-regular fa-clock"></i> Loading new arrivals...</span>
      </div>
    </div>

    <div class="container">
      <div class="sort-bar">
        <div class="sort-select">
          <i class="fa-solid fa-arrow-down-wide-short"></i>
          <select id="sort-select" aria-label="Sort products">
            <option value="newest">sort by: newest first</option>
            <option value="price-low">price: low to high</option>
            <option value="price-high">price: high to low</option>
            <option value="rating">top rated</option>
          </select>
        </div>
      </div>
    </div>

    <div class="container">
      <div id="results-count" class="results-count"></div>
      <div id="product-grid-container" class="product-grid"></div>
    </div>
  </main>

  <!-- Footer loaded dynamically -->
  <div id="footer"></div>

  <!-- Common Modals -->
  <div id="common-modals"></div>

  <!-- Common JavaScript -->
  <script src="common.js"></script>

<script>
    // ========== NEW ARRIVALS PAGE SPECIFIC VARIABLES ==========
    let newProducts = [];

    // ========== NEW ARRIVALS MONITOR ==========
    function getNewArrivals() {
      const now = new Date();
      const sevenDaysAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
      
      return products.filter(product => {
        // Check if product has showOnNew flag or is within last 7 days
        if (product.showOnNew === true) return true;
        
        if (product.creationDate) {
          const productDate = new Date(product.creationDate);
          return productDate >= sevenDaysAgo;
        }
        return false;
      });
    }

    function updateNewCounter() {
      const counter = document.getElementById('new-counter');
      const newArrivals = getNewArrivals();
      
      if (counter) {
        const count = newArrivals.length;
        const today = newArrivals.filter(p => {
          if (!p.creationDate) return false;
          const productDate = new Date(p.creationDate);
          const now = new Date();
          return (now - productDate) < 24 * 60 * 60 * 1000;
        }).length;
        
        counter.innerHTML = `
          <span>
            <i class="fa-regular fa-clock"></i> 
            ${count} new item${count !== 1 ? 's' : ''} added this week 
            ${today > 0 ? `( ${today} new today! )` : ''}
          </span>
        `;
      }
    }

    // ========== PRODUCT RENDERING ==========
    function renderProducts() {
      const gridContainer = document.getElementById('product-grid-container');
      const sortSelect = document.getElementById('sort-select');
      const resultsCount = document.getElementById('results-count');
      
      if (!gridContainer) return;

      // Get all new arrivals
      newProducts = getNewArrivals();

      // Update counter
      updateNewCounter();

      if (newProducts.length === 0) {
        gridContainer.innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 4rem; color: #999;">
            <i class="fa-regular fa-clock" style="font-size: 4rem; margin-bottom: 1rem;"></i>
            <h3>No new arrivals yet</h3>
            <p>Check back soon for fresh products!</p>
          </div>
        `;
        if (resultsCount) resultsCount.innerHTML = 'Showing 0 products';
        return;
      }

      function isToday(dateString) {
        if (!dateString) return false;
        const productDate = new Date(dateString);
        const now = new Date();
        return (now - productDate) < 24 * 60 * 60 * 1000;
      }

      function formatPrice(price) {
        return price.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
      }

      function renderRating(rating) {
        let stars = '';
        for (let i = 1; i <= 5; i++) {
          if (rating >= i) stars += '<i class="fa-solid fa-star"></i>';
          else if (rating > i - 1 && rating < i) stars += '<i class="fa-solid fa-star-half-alt"></i>';
          else stars += '<i class="fa-regular fa-star"></i>';
        }
        return stars;
      }

      function getSortedProducts() {
        let sorted = [...newProducts];
        switch (sortSelect.value) {
          case 'price-low':
            sorted.sort((a, b) => a.price - b.price);
            break;
          case 'price-high':
            sorted.sort((a, b) => b.price - a.price);
            break;
          case 'rating':
            sorted.sort((a, b) => b.rating - a.rating);
            break;
          case 'newest':
          default:
            sorted.sort((a, b) => {
              const dateA = a.creationDate ? new Date(a.creationDate) : new Date(0);
              const dateB = b.creationDate ? new Date(b.creationDate) : new Date(0);
              return dateB - dateA;
            });
            break;
        }
        return sorted;
      }

      function renderAllProducts() {
        const sortedProducts = getSortedProducts();
        
        // Update results count
        if (resultsCount) {
          resultsCount.innerHTML = `Showing ${sortedProducts.length} new arrival${sortedProducts.length !== 1 ? 's' : ''}`;
        }
        
        let gridHtml = '';
        sortedProducts.forEach(product => {
          const mainImage = product.images && product.images[0] ? product.images[0] : (product.primaryImg || 'https://via.placeholder.com/300');
          const secondImage = product.images && product.images[1] ? product.images[1] : (product.secondaryImg || mainImage);
          const isBrandNew = isToday(product.creationDate);
          const hasSale = product.onSale && product.originalPrice;
          const discount = hasSale ? Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100) : 0;
          
          gridHtml += `
            <a href="product.html?id=${product.id}" class="product-card" data-product-id="${product.id}">
              <span class="new-badge">
                <i class="fa-regular fa-${isBrandNew ? 'star' : 'clock'}"></i> 
                ${isBrandNew ? 'just landed' : 'new this week'}
              </span>
              ${hasSale ? `<span class="sale-badge">-${discount}%</span>` : ''}
              <div class="image-frame">
                <div class="primary-img" style="background-image: url('${mainImage}');"></div>
                <div class="secondary-img" style="background-image: url('${secondImage}');"></div>
                <div class="image-actions" onclick="event.preventDefault(); event.stopPropagation();">
                  <button class="img-add" onclick="window.addToCart('${product.id}'); event.preventDefault(); event.stopPropagation();">
                    <i class="fa-solid fa-cart-plus"></i> add
                  </button>
                  <button class="img-buy" onclick="window.buyNow('${product.id}'); event.preventDefault(); event.stopPropagation();">
                    <i class="fa-solid fa-bolt"></i> buy
                  </button>
                </div>
              </div>
              <h3 class="product-title">${product.title}</h3>
              <p class="product-category">${product.category}</p>
              <div class="product-rating">
                ${renderRating(product.rating)}
                <span>(${product.rating.toFixed(1)})</span>
              </div>
              <div class="product-price">
                ${hasSale ? `<span class="original-price">₹${formatPrice(product.originalPrice)}</span>` : ''}
                <span class="inr-symbol">₹</span>${formatPrice(product.price)}
              </div>
              <span class="stock-badge ${product.stock > 10 ? 'in-stock' : (product.stock > 0 ? 'low-stock' : 'out-of-stock')}">
                ${product.stock > 10 ? 'In Stock' : (product.stock > 0 ? 'Low Stock' : 'Out of Stock')}
              </span>
            </a>
          `;
        });
        
        gridContainer.innerHTML = gridHtml;
      }

      renderAllProducts();
      
      if (sortSelect) {
        sortSelect.removeEventListener('change', renderAllProducts);
        sortSelect.addEventListener('change', renderAllProducts);
      }
    }

    // ========== INITIALIZATION ==========
    function initializeApp() {
      updateCartCount();
      renderProducts();
      
      // currentUser is now managed by Firebase in common.js
      // No need to load from localStorage
      
      // Update new arrivals every minute
      setInterval(renderProducts, 60000);
    }

    // Load common modals
    async function loadCommonModals() {
      try {
        const response = await fetch('common.html');
        const data = await response.text();
        document.getElementById('common-modals').innerHTML = data;
      } catch (error) {
        console.error('Error loading common modals:', error);
      }
    }

    // Listen for product updates from Firebase
    firebase.auth().onAuthStateChanged((user) => {
      // When auth state changes, products might be reloaded
      // Re-render products if they're already loaded
      if (products.length > 0) {
        renderProducts();
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      loadCommonModals();
      loadComponents();
    });

    // Add fallback for products
    window.addEventListener('load', () => {
      if (products.length === 0) {
        const cachedProducts = localStorage.getItem('MyEssantia_products');
        if (cachedProducts) {
          products = JSON.parse(cachedProducts);
          renderProducts();
        }
      }
    });
  </script>
</body>
</html>
